#!/usr/bin/env bash
#
# Yao Zheng (zheng.iao@icloud.com)
# 2011/05/25-

cd "$(dirname "${BASH_SOURCE[0]}")" || exit 1
BASE=$(pwd)

if [ "$(uname -s)" = 'Darwin' ]; then
  # Homebrew
  [ -z "$(which brew)" ] &&
    ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

  # Taps (third-party repositories)
  brew tap waltarix/homebrew-customs
  brew tap universal-ctags/universal-ctags

  # Languages
  brew install ruby python go

  # Shells
  brew install zsh fish bash-completion

  # Terminal
  brew install waltarix/homebrew-customs/tmux reattach-to-user-namespace

  # Email
  brew install neomutt/homebrew-neomutt/neomutt \
                 --with-sidebar-patch --with-notmuch-patch --HEAD \
               isync msmtp notmuch lbdb terminal-notifier lmdb

  # FZF
  brew install fd ag ripgrep jq highlight html2text
  brew cask install pdftotext

  # VIM
  brew install neovim cscope universal-ctags --HEAD
  gem install gem-ctags
  gem ctags

  # Libraries
  brew install liboauth

  # Commandline software
  brew install coreutils wget tree git stow dtrx \
       ant leigingen sbt maven hugo \
       exiftool doxygen graphviz imagemagick gnuplot --with-qt@5.7 \
       ranger cmus

  # Apps
  brew cask install iterm2 xquartz dropbox spectacle flycut keycastr flux
fi

# blsd
command -v blsd > /dev/null ||
  (bash <(curl -fL https://raw.githubusercontent.com/junegunn/blsd/master/install) && mv blsd ~/.local/bin)

# git-prompt
if [ ! -e ~/.git-prompt.sh ]; then
  curl https://raw.githubusercontent.com/git/git/master/contrib/completion/git-prompt.sh -o ~/.git-prompt.sh
fi

# RC files
touch bashrc-extra
for rc in *rc *profile tmux.conf agignore Renviron rubocop.yml; do
  mkdir -pv bak
  [ -e ~/."$rc" ] && mv -v ~/."$rc" bak/."$rc"
  ln -sfv "$BASE/$rc" ~/."$rc"
done

# todo
mkdir -p ~/.todo
ln -svf $BASE/todoconfig ~/.todo/config

# scripts
mkdir -p ~/.local/bin
for bin in $BASE/bin/*; do
  ln -svf "$bin" ~/.local/bin
done

# leiningen
mkdir -p ~/.lein
ln -sfv "$BASE/profiles.clj" ~/.lein/


if [ "$(uname -s)" = 'Linux' ]; then
  rm -f ~/.tmux.conf
  grep -v reattach-to-user-namespace tmux.conf > ~/.tmux.conf
fi

tmux source-file ~/.tmux.conf

./install-vim
